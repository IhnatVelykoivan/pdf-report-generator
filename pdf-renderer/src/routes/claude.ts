import express from 'express';
import axios from 'axios';

const router = express.Router();

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ç–∏–ø–∏–∑–∞—Ü–∏–∏
interface ChatMessage {
    role: 'user' | 'assistant';
    content: string;
}

interface ClaudeRequest {
    messages: ChatMessage[];
    systemPrompt?: string;
    maxTokens?: number;
}

interface DSLGenerationRequest {
    conversationHistory: ChatMessage[];
}

interface FeedbackRequest {
    currentDSL: any;
    userFeedback: string;
}

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Ç–≤–µ—Ç–∞ Claude API
interface ClaudeResponse {
    content: Array<{
        text: string;
        type: string;
    }>;
    id: string;
    model: string;
    role: string;
    stop_reason: string;
    stop_sequence: null;
    type: string;
    usage: {
        input_tokens: number;
        output_tokens: number;
    };
}

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Claude API
const CLAUDE_API_URL = 'https://api.anthropic.com/v1/messages';
const CLAUDE_API_KEY = process.env.CLAUDE_API_KEY;

if (!CLAUDE_API_KEY) {
    console.warn('‚ö†Ô∏è CLAUDE_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è');
}

// –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ Claude API
async function callClaudeAPI(messages: ChatMessage[], systemPrompt: string, maxTokens = 4000): Promise<string> {
    try {
        console.log('ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Claude API...');

        const response = await axios.post<ClaudeResponse>(CLAUDE_API_URL, {
            model: 'claude-3-sonnet-20240229',
            max_tokens: maxTokens,
            messages: messages,
            system: systemPrompt
        }, {
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': CLAUDE_API_KEY,
                'anthropic-version': '2023-06-01'
            }
        });

        console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Claude');
        return response.data.content[0].text;
    } catch (error: any) {
        console.error('‚ùå –û—à–∏–±–∫–∞ Claude API:', error);

        if (error.response) {
            // Axios error with response
            const statusCode = error.response.status || 500;
            const errorMessage = error.response.data?.error?.message || error.message || 'Unknown error';
            throw new Error(`Claude API Error: ${statusCode} - ${errorMessage}`);
        } else if (error.request) {
            // Axios error without response
            throw new Error(`Network Error: ${error.message || 'No response from server'}`);
        } else {
            // Other error
            throw new Error(`Request Error: ${error.message || 'Unknown error'}`);
        }
    }
}

// –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
router.post('/chat', async (req, res) => {
    try {
        const { messages, systemPrompt }: ClaudeRequest = req.body;

        if (!messages || !Array.isArray(messages)) {
            return res.status(400).json({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π' });
        }

        const defaultSystemPrompt = `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é PDF –æ—Ç—á—ë—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞:

1. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤
2. –ó–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π  
3. –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞
4. –ë—ã—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è.

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—Ç–æ—á–Ω–∏:
- –¢–∏–ø –æ—Ç—á—ë—Ç–∞ (–º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –ø—Ä–æ–¥–∞–∂–∏, —Ñ–∏–Ω–∞–Ω—Å—ã, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞)
- –ü–µ—Ä–∏–æ–¥ –æ—Ç—á—ë—Ç–∞
- –¶–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é
- –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ
- –Ø–∑—ã–∫ –æ—Ç—á—ë—Ç–∞

–ü—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏ –±—É–¥—å –≥–æ—Ç–æ–≤ —Å–æ–∑–¥–∞—Ç—å DSL —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è PDF –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞.`;

        const response = await callClaudeAPI(
            messages,
            systemPrompt || defaultSystemPrompt
        );

        res.json({ response });
    } catch (error: any) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ /chat:', error);
        res.status(500).json({
            error: error.message || '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
        });
    }
});

// –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ DSL
router.post('/generate-dsl', async (req, res) => {
    try {
        const { conversationHistory }: DSLGenerationRequest = req.body;

        if (!conversationHistory || !Array.isArray(conversationHistory)) {
            return res.status(400).json({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∏—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞' });
        }

        const systemPrompt = `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é DSL (Domain Specific Language) —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–ª—è PDF –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞.

–ù–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å–æ–∑–¥–∞–π JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –æ—Ç—á—ë—Ç–∞.

–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —à—Ä–∏—Ñ—Ç–æ–≤ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞:
- –î–ª—è –∞—Ä–∞–±—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞: font: "DejaVuSans", direction: "rtl", align: "right"
- –î–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ/—Ä—É—Å—Å–∫–æ–≥–æ: font: "DejaVuSans", direction: "ltr"
- –î–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –∞—Ä–∞–±—Å–∫–∏–º: rtl: true, textDirection: "rtl", font: {family: "DejaVuSans"}

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ DSL –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å:
- template: —Ç–∏–ø —à–∞–±–ª–æ–Ω–∞
- defaultDirection: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ text (ltr/rtl)
- defaultFont: "DejaVuSans"
- pages: –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–∞–Ω–∏—Ü —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏

–ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–æ–∂–µ—Ç –±—ã—Ç—å:
- text: —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫
- chart: –≥—Ä–∞—Ñ–∏–∫ –∏–ª–∏ –¥–∏–∞–≥—Ä–∞–º–º–∞  
- table: —Ç–∞–±–ª–∏—Ü–∞
- image: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á–∏—Ç—ã–≤–∞–π:
1. –Ø–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ (—Ä—É—Å—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π/–∞—Ä–∞–±—Å–∫–∏–π)
2. –¢–∏–ø –æ—Ç—á—ë—Ç–∞ (–º–∞—Ä–∫–µ—Ç–∏–Ω–≥/–ø—Ä–æ–¥–∞–∂–∏/—Ñ–∏–Ω–∞–Ω—Å—ã)
3. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
    "dsl": { DSL —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ },
    "explanation": "–û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç—á—ë—Ç–∞",
    "suggestions": ["–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 1", "–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 2"]
}`;

        const conversationText = conversationHistory
            .map(msg => `${msg.role}: ${msg.content}`)
            .join('\n\n');

        const prompt = `–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä –∏ —Å–æ–∑–¥–∞–π DSL —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

${conversationText}

–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—É—é DSL —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è PDF –æ—Ç—á—ë—Ç–∞.`;

        const response = await callClaudeAPI([
            { role: 'user', content: prompt }
        ], systemPrompt);

        // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
        try {
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const result = JSON.parse(jsonMatch[0]);
                res.json(result);
            } else {
                // –°–æ–∑–¥–∞—ë–º fallback DSL
                res.json(createFallbackDSL(conversationHistory));
            }
        } catch (parseError) {
            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
            res.json(createFallbackDSL(conversationHistory));
        }

    } catch (error: any) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ /generate-dsl:', error);
        res.status(500).json({
            error: error.message || '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
        });
    }
});

// –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∏–¥–±–µ–∫–∞
router.post('/feedback', async (req, res) => {
    try {
        const { currentDSL, userFeedback }: FeedbackRequest = req.body;

        if (!currentDSL || !userFeedback) {
            return res.status(400).json({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º—ã currentDSL –∏ userFeedback' });
        }

        const systemPrompt = `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —É–ª—É—á—à–µ–Ω–∏—é PDF –æ—Ç—á—ë—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–¥–±–µ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

–ü–æ–ª—É—á–∏ —Ç–µ–∫—É—â—É—é DSL —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Ñ–∏–¥–±–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞—Ç–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏ —É–ª—É—á—à–µ–Ω–∏—è.

–í–ê–ñ–ù–û: –°–æ–±–ª—é–¥–∞–π –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —à—Ä–∏—Ñ—Ç–æ–≤:
- –î–ª—è –∞—Ä–∞–±—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞: font: "DejaVuSans", direction: "rtl", align: "right"
- –î–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –∞—Ä–∞–±—Å–∫–∏–º: rtl: true, textDirection: "rtl", font: {family: "DejaVuSans"}

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{
    "dsl": { –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è DSL —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ },
    "explanation": "–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤–Ω–µ—Å—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π",
    "suggestions": ["–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 1", "–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 2"]
}`;

        const prompt = `–¢–µ–∫—É—â–∞—è DSL —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
${JSON.stringify(currentDSL, null, 2)}

–§–∏–¥–±–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
${userFeedback}

–£–ª—É—á—à–∏ DSL —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–≥–ª–∞—Å–Ω–æ —Ñ–∏–¥–±–µ–∫—É.`;

        const response = await callClaudeAPI([
            { role: 'user', content: prompt }
        ], systemPrompt);

        try {
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const result = JSON.parse(jsonMatch[0]);
                res.json(result);
            } else {
                res.json({
                    dsl: currentDSL,
                    explanation: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∏–¥–±–µ–∫, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–ª–∞—Å—å –ø—Ä–µ–∂–Ω–µ–π',
                    suggestions: ['–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å']
                });
            }
        } catch (parseError) {
            res.json({
                dsl: currentDSL,
                explanation: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∏–¥–±–µ–∫, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–ª–∞—Å—å –ø—Ä–µ–∂–Ω–µ–π',
                suggestions: ['–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å']
            });
        }

    } catch (error: any) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ /feedback:', error);
        res.status(500).json({
            error: error.message || '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
        });
    }
});

// –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è fallback DSL (–æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Ç–µ—Å—Ç–µ)
function createFallbackDSL(conversationHistory: ChatMessage[]) {
    const lastUserMessage = conversationHistory
        .filter(msg => msg.role === 'user')
        .pop()?.content || '–ë–∞–∑–æ–≤—ã–π –æ—Ç—á—ë—Ç';

    const language = detectLanguage(lastUserMessage);
    const reportType = detectReportType(lastUserMessage);
    const isRTL = language === 'arabic';

    console.log(`üîß –°–æ–∑–¥–∞—ë–º —É–ª—É—á—à–µ–Ω–Ω—ã–π fallback DSL: —è–∑—ã–∫=${language}, —Ç–∏–ø=${reportType}, RTL=${isRTL}`);

    const title = extractTitle(lastUserMessage);
    const content = generateContent(reportType, language);

    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–ø–æ –æ–±—Ä–∞–∑—Ü—É —Ä–∞–±–æ—á–µ–≥–æ —Ç–µ—Å—Ç–∞)
    const createTextElement = (text: string, position: {x: number, y: number}, extraStyle: any = {}) => {
        const hasArabic = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/.test(text);
        const elementIsRTL = hasArabic || isRTL;

        return {
            type: 'text',
            content: text,
            position: position,
            style: {
                font: 'DejaVuSans', // –ò—Å–ø–æ–ª—å–∑—É–µ–º DejaVuSans –∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º —Ç–µ—Å—Ç–µ
                direction: elementIsRTL ? 'rtl' : 'ltr',
                align: elementIsRTL ? 'right' : 'left',
                ...extraStyle,
                // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –∞—Ä–∞–±—Å–∫–∏–π —Ç–µ–∫—Å—Ç
                ...(hasArabic ? { align: extraStyle.align === 'center' ? 'center' : 'right' } : {})
            }
        };
    };

    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è RTL
    const createChartElement = (position: {x: number, y: number}) => {
        const chart = generateSampleChart(reportType, language);

        // –î–æ–±–∞–≤–ª—è–µ–º RTL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∞—Ä–∞–±—Å–∫–∏—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º —Ç–µ—Å—Ç–µ)
        if (isRTL) {
            chart.options = {
                ...chart.options,
                rtl: true,
                font: { family: 'DejaVuSans' }
            };
            chart.textDirection = 'rtl';
        }

        return {
            type: 'chart',
            content: chart,
            position: position,
            style: {
                width: 495, // –ö–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º —Ç–µ—Å—Ç–µ
                height: 250,
                backgroundColor: '#FFFFFF',
                borderColor: '#BDC3C7'
            }
        };
    };

    const dsl = {
        template: 'default',
        defaultFont: 'DejaVuSans', // –ö–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º —Ç–µ—Å—Ç–µ
        defaultDirection: isRTL ? 'rtl' : 'ltr',
        pages: [{
            elements: [
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
                createTextElement(title, { x: 50, y: 100 }, { // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º —Ç–µ—Å—Ç–µ
                    fontSize: 24,
                    color: '#2C3E50',
                    width: 495,
                    align: 'center'
                }),

                // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
                createTextElement(content, { x: 50, y: 170 }, {
                    fontSize: 12,
                    color: '#34495E',
                    width: 495,
                    lineBreak: true
                }),

                // –ì—Ä–∞—Ñ–∏–∫
                createChartElement({ x: 50, y: 430 }),

                // –ó–∞–∫–ª—é—á–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
                createTextElement(getConclusion(language), { x: 50, y: 700 }, {
                    fontSize: 11,
                    color: '#7F8C8D',
                    width: 495,
                    lineBreak: true
                })
            ],
            style: {
                size: 'a4',
                margin: { top: 70, bottom: 70, left: 50, right: 50 } // –ö–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º —Ç–µ—Å—Ç–µ
            }
        }]
    };

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ DSL
    const validatedDSL = ensureDSLFontsAndDirection(dsl);

    return {
        dsl: validatedDSL,
        explanation: `–°–æ–∑–¥–∞–Ω ${reportType} –æ—Ç—á—ë—Ç –Ω–∞ ${language === 'russian' ? '—Ä—É—Å—Å–∫–æ–º' : language === 'english' ? '–∞–Ω–≥–ª–∏–π—Å–∫–æ–º' : '–∞—Ä–∞–±—Å–∫–æ–º'} —è–∑—ã–∫–µ (—É–ª—É—á—à–µ–Ω–Ω–∞—è fallback –≤–µ—Ä—Å–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —à—Ä–∏—Ñ—Ç–∞–º–∏)`,
        suggestions: [
            '–î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –¥–∏–∞–≥—Ä–∞–º–º',
            '–í–∫–ª—é—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã',
            '–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è',
            '–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∞–Ω–Ω—ã–º–∏'
        ]
    };
}

// –ù–û–í–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ DSL
function ensureDSLFontsAndDirection(dsl: any): any {
    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º DSL –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —à—Ä–∏—Ñ—Ç–æ–≤ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è...');

    if (!dsl.pages || !Array.isArray(dsl.pages)) {
        return dsl;
    }

    for (const page of dsl.pages) {
        if (!page.elements || !Array.isArray(page.elements)) {
            continue;
        }

        for (const element of page.elements) {
            if (element.type === 'text' && element.content) {
                const content = String(element.content);
                const hasArabic = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/.test(content);

                // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ style
                if (!element.style) {
                    element.style = {};
                }

                // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                if (hasArabic) {
                    element.style.font = 'DejaVuSans'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º DejaVuSans –∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º —Ç–µ—Å—Ç–µ
                    element.style.direction = 'rtl';

                    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–ª—è –∞—Ä–∞–±—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                    if (!element.style.align || element.style.align === 'left') {
                        element.style.align = element.style.align === 'center' ? 'center' : 'right';
                    }

                    console.log(`üîß –ò–°–ü–†–ê–í–õ–ï–ù –∞—Ä–∞–±—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç: "${content.substring(0, 30)}..." -> font=DejaVuSans, direction=rtl, align=${element.style.align}`);
                } else {
                    // –î–ª—è –Ω–µ-–∞—Ä–∞–±—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                    if (!element.style.font) {
                        element.style.font = 'DejaVuSans';
                    }
                    if (!element.style.direction) {
                        element.style.direction = 'ltr';
                    }

                    console.log(`‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω —ç–ª–µ–º–µ–Ω—Ç: "${content.substring(0, 30)}..." -> font=${element.style.font}, direction=${element.style.direction}`);
                }
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            if (element.type === 'chart' && element.content) {
                const chart = element.content;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä–∞—Ñ–∏–∫–∞
                if (chart.title) {
                    const hasArabic = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/.test(chart.title);

                    if (!chart.options) {
                        chart.options = {};
                    }

                    if (hasArabic) {
                        chart.options.rtl = true;
                        chart.options.font = { family: 'DejaVuSans' }; // –ò—Å–ø–æ–ª—å–∑—É–µ–º DejaVuSans –∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º —Ç–µ—Å—Ç–µ
                        chart.textDirection = 'rtl'; // –î–æ–±–∞–≤–ª—è–µ–º textDirection –∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º —Ç–µ—Å—Ç–µ
                        console.log(`üîß –ò–°–ü–†–ê–í–õ–ï–ù –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä–∞—Ñ–∏–∫–∞: "${chart.title}" -> rtl=true, font=DejaVuSans, textDirection=rtl`);
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö
                if (chart.data && chart.data.labels) {
                    const hasArabicLabels = chart.data.labels.some((label: string) =>
                        /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/.test(label)
                    );

                    if (hasArabicLabels) {
                        if (!chart.options) {
                            chart.options = {};
                        }
                        chart.options.rtl = true;
                        chart.options.font = { family: 'DejaVuSans' };
                        chart.textDirection = 'rtl';
                        console.log(`üîß –ò–°–ü–†–ê–í–õ–ï–ù–´ –ø–æ–¥–ø–∏—Å–∏ –≥—Ä–∞—Ñ–∏–∫–∞ —Å –∞—Ä–∞–±—Å–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º -> rtl=true, font=DejaVuSans, textDirection=rtl`);
                    }
                }
            }
        }
    }

    console.log('‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ DSL –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    return dsl;
}

// –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function detectLanguage(text: string): 'russian' | 'english' | 'arabic' {
    if (/[\u0600-\u06FF]/.test(text)) return 'arabic';
    if (/[–∞-—è—ë]/i.test(text)) return 'russian';
    return 'english';
}

function detectReportType(text: string): string {
    const lower = text.toLowerCase();
    if (lower.includes('–º–∞—Ä–∫–µ—Ç–∏–Ω–≥') || lower.includes('marketing')) return 'marketing';
    if (lower.includes('–ø—Ä–æ–¥–∞–∂') || lower.includes('sales')) return 'sales';
    if (lower.includes('—Ñ–∏–Ω–∞–Ω—Å') || lower.includes('financial')) return 'financial';
    if (lower.includes('–∞–Ω–∞–ª–∏—Ç–∏–∫') || lower.includes('analytics')) return 'analytics';
    return 'general';
}

function extractTitle(text: string): string {
    const words = text.split(' ').slice(0, 6);
    return words.join(' ') + (text.split(' ').length > 6 ? '...' : '');
}

function generateContent(reportType: string, language: string): string {
    const content = {
        russian: {
            marketing: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç —Å –∞–Ω–∞–ª–∏–∑–æ–º –∫–∞–º–ø–∞–Ω–∏–π –∏ ROI',
            sales: '–û—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º —Å –¥–∏–Ω–∞–º–∏–∫–æ–π –∏ –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏',
            financial: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç —Å –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
            analytics: '–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç —Å —Ç—Ä–µ–Ω–¥–∞–º–∏ –∏ –∏–Ω—Å–∞–π—Ç–∞–º–∏',
            general: '–û–±—â–∏–π –æ—Ç—á—ë—Ç —Å –∫–ª—é—á–µ–≤—ã–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏'
        },
        english: {
            marketing: 'Marketing report with campaign analysis and ROI',
            sales: 'Sales report with dynamics and forecasts',
            financial: 'Financial report with performance metrics',
            analytics: 'Analytics report with trends and insights',
            general: 'General report with key indicators'
        },
        arabic: {
            marketing: 'ÿ™ŸÇÿ±Ÿäÿ± ÿ™ÿ≥ŸàŸäŸÇŸä ŸÖÿπ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ≠ŸÖŸÑÿßÿ™ ŸàÿßŸÑÿπÿßÿ¶ÿØ ÿπŸÑŸâ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±',
            sales: 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸÖÿπ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßÿ™ ŸàÿßŸÑÿ™ŸàŸÇÿπÿßÿ™',
            financial: 'ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿßŸÑŸä ŸÖÿπ ŸÖŸÇÿßŸäŸäÿ≥ ÿßŸÑÿ£ÿØÿßÿ°',
            analytics: 'ÿ™ŸÇÿ±Ÿäÿ± ÿ™ÿ≠ŸÑŸäŸÑŸä ŸÖÿπ ÿßŸÑÿßÿ™ÿ¨ÿßŸáÿßÿ™ ŸàÿßŸÑÿ±ÿ§Ÿâ',
            general: 'ÿ™ŸÇÿ±Ÿäÿ± ÿπÿßŸÖ ŸÖÿπ ÿßŸÑŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©'
        }
    };

    return content[language as keyof typeof content]?.[reportType as keyof typeof content.russian] ||
        content.russian.general;
}

function generateSampleChart(reportType: string, language: string): any {
    const isRTL = language === 'arabic';

    const chart = {
        type: 'bar',
        title: language === 'arabic' ? 'ÿßŸÑŸÜÿ¥ÿßÿ∑ ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿä' :
            language === 'english' ? 'Business Activity' :
                '–î–µ–ª–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
        data: {
            labels: language === 'arabic' ? ['ŸäŸÜÿßŸäÿ±', 'ŸÅÿ®ÿ±ÿßŸäÿ±', 'ŸÖÿßÿ±ÿ≥', 'ÿ£ÿ®ÿ±ŸäŸÑ', 'ŸÖÿßŸäŸà'] :
                language === 'english' ? ['Jan', 'Feb', 'Mar', 'Apr', 'May'] :
                    ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π'],
            datasets: [{
                label: language === 'arabic' ? 'ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™' :
                    language === 'english' ? 'Sales' :
                        '–ü—Ä–æ–¥–∞–∂–∏',
                data: [12, 19, 8, 15, 6],
                backgroundColor: ['#E74C3C', '#3498DB', '#F39C12', '#27AE60', '#9B59B6'],
                borderColor: ['#C0392B', '#2980B9', '#E67E22', '#229954', '#8E44AD'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: false,
            animation: false
        }
    };

    return chart;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –Ω—É–∂–Ω–æ–º —è–∑—ã–∫–µ
function getConclusion(language: string): string {
    const conclusions = {
        russian: '–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:\n\n–î–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º.',
        english: 'Conclusion:\n\nThis report was automatically generated based on your requirements. For more detailed information, please contact our specialists.',
        arabic: 'ÿßŸÑÿÆŸÑÿßÿµÿ©:\n\nÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÖÿ™ÿ∑ŸÑÿ®ÿßÿ™ŸÉŸÖ. ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ£ŸÉÿ´ÿ± ÿ™ŸÅÿµŸäŸÑÿßŸãÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÖÿÆÿ™ÿµŸäŸÜ.'
    };

    return conclusions[language as keyof typeof conclusions] || conclusions.russian;
}

export default router;